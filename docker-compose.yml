# Docker Compose para Steam Bundle Scraper
# Otimizado para Orange Pi com proteção do cartão SD

version: '3.8'

services:
  # Banco de dados PostgreSQL
  postgres:
    image: postgres:15-alpine
    container_name: steam_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: steam
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
      POSTGRES_DB: steam_bundles
    volumes:
      # Dados do banco em volume Docker (não no SD Card)
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U steam -d steam_bundles"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Scraper com CRON - Sistema Autônomo
  scraper:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: steam_scraper
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Sobrescreve apenas o necessário
      DATABASE_URL: postgresql+asyncpg://steam:${DB_PASSWORD:-changeme}@postgres/steam_bundles
      DOCKER_ENV: "true"
      DISABLE_FILE_LOGS: "true"
      PYTHONUNBUFFERED: "1"
      TZ: America/Sao_Paulo
    
    tmpfs:
      - /app/logs:size=50M
    
    volumes:
      - ./scraper:/app/scraper:ro
      - ./scripts:/app/scripts:ro
      - ./scripts/crontab:/etc/cron.d/steam-scraper:ro
      - data_volume:/app/data
    
    # Usa script de entrypoint personalizado
    command: ["/bin/sh", "-c", "crontab /etc/cron.d/steam-scraper && cron -f -l 2"]
    
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 256M

  # Cloudflare Tunnel para acesso externo
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${TUNNEL_TOKEN}

volumes:
  # Volume Docker gerenciado (melhor performance que bind mount no SD)
  postgres_data:
    driver: local
  data_volume:
    driver: local

networks:
  default:
    name: steam_network
    enable_ipv6: true
    ipam:
      config:
        - subnet: 172.20.0.0/16
        - subnet: fd00::/64
