# SteamBundleAPI

Uma API segura e robusta para buscar e gerenciar bundles da Steam Store.

## ‚ö° OTIMIZA√á√ïES DE PERFORMANCE E MEM√ìRIA

### üîÑ Sistema Keep-Alive Anti-Sono (NOVO!)
**Problema**: Render Free dorme ap√≥s 15 minutos de inatividade, interrompendo atualiza√ß√µes longas.
**Solu√ß√£o**: Sistema autom√°tico de keep-alive que mant√©m a API acordada durante opera√ß√µes.

**Como funciona:**
- ‚úÖ **Ativa√ß√£o autom√°tica** durante atualiza√ß√µes longas (`/api/force-update`)
- ‚úÖ **Auto-ping** a cada 8 minutos em endpoints leves (`/api/steam-stats`, `/`)
- ‚úÖ **Prote√ß√£o de 24h** - m√°ximo 180 pings (suficiente para qualquer atualiza√ß√£o)
- ‚úÖ **Zero impacto** - usa endpoints p√∫blicos existentes
- ‚úÖ **Parada autom√°tica** quando atualiza√ß√£o completa ou atinge limite

**Controles administrativos:**
```bash
# Verificar status do anti-sono
GET /api/keep-alive-status?api_key=SUA_CHAVE

# Controle manual (emerg√™ncia)
GET /api/keep-alive-start?api_key=SUA_CHAVE
GET /api/keep-alive-stop?api_key=SUA_CHAVE
GET /api/keep-alive-ping?api_key=SUA_CHAVE
```

### üìã Sistema de Resumo Autom√°tico (NOVO!)
**Problema**: Se a API dormir/reiniciar, perde todo progresso da atualiza√ß√£o.
**Solu√ß√£o**: Sistema de checkpoint que salva progresso e continua de onde parou.

**Como funciona:**
- ‚úÖ **Checkpoint autom√°tico** a cada lote processado
- ‚úÖ **Detec√ß√£o na inicializa√ß√£o** - verifica se h√° trabalho incompleto  
- ‚úÖ **Resumo seamless** - continua exatamente de onde parou
- ‚úÖ **Estado persistente** - arquivo `updateState.json` com progresso
- ‚úÖ **Logs informativos** - mostra resumos, tempo total, progresso

**Monitoramento:**
```bash
# Verificar se h√° atualiza√ß√µes incompletas
GET /api/update-resume-status?api_key=SUA_CHAVE

# Limpar estado (for√ßar rein√≠cio do zero)
GET /api/update-resume-clear?api_key=SUA_CHAVE
```

### Processamento Otimizado para Render Free
A vers√£o atual inclui otimiza√ß√µes espec√≠ficas para **Render Free (500MB RAM)** que garantem estabilidade e performance:

- **üß† Gerenciamento de Mem√≥ria**: Monitoramento ativo com salvamento quando atinge 300-350MB
- **ÔøΩ Salvamento Inteligente**: Redu√ß√£o de 95% nas opera√ß√µes de disco (salva a cada 20-50 lotes ao inv√©s de constantemente)
- **üö® Detec√ß√£o de Bloqueio**: Para automaticamente se detectar bloqueio IP da Steam (Status 403)
- **üóÇÔ∏è Sistema de Backup**: Rota√ß√£o autom√°tica de arquivos com recupera√ß√£o em caso de erro
- **üßπ Deduplica√ß√£o Autom√°tica**: Remove duplicatas antes de salvar, evitando dados corrompidos
- **üìä Monitoramento em Tempo Real**: Logs de mem√≥ria, progresso e ETA

### Scripts de Performance

```bash
# Teste as otimiza√ß√µes primeiro (pequeno lote)
curl "https://steambundleapi.onrender.com/api/test-update?limit=10&api_key=SUA_KEY"

# Verificar configura√ß√µes e status
curl "https://steambundleapi.onrender.com/api/steam-stats"
```

### Configura√ß√µes de Velocidade (Performance Otimizada para Render Free)

Copie estas configura√ß√µes para as vari√°veis de ambiente no Render:

```bash
# RENDER FREE - CONFIGURA√á√ÉO ALTA PERFORMANCE (Recomendada)
NODE_ENV=production
TIMEZONE=America/Sao_Paulo

# Fetch Bundles (coleta da lista b√°sica) - OTIMIZADO
FETCH_BUNDLES_CONCURRENT=2      # 2 requisi√ß√µes paralelas (era 1)
FETCH_BUNDLES_DELAY=1500        # 1.5 segundos entre lotes (era 3000)
FETCH_BUNDLES_TIMEOUT=15000     # 15s timeout

# Update Bundles (detalhes das bundles) - ALTA PERFORMANCE
STEAM_API_DELAY=1000            # 1 segundo entre bundles (era 2000)
STEAM_APP_DELAY=300             # 300ms entre apps (era 500)
MAX_APPS_PER_BUNDLE=30          # M√°ximo 30 apps por bundle (era 20)
REQUEST_TIMEOUT=15000           # 15s timeout
MAX_RETRIES=3                   # 3 tentativas por erro
PARALLEL_BUNDLES=4              # 4 bundles paralelas (era 2)
APP_BATCH_SIZE=5                # 5 apps por lote (era 3)
SKIP_DETAILS_THRESHOLD=60       # Pula bundles com +60 apps (era 50)

# CONFIGURA√á√ÉO CONSERVADORA - FALLBACK SE HOUVER PROBLEMAS
PARALLEL_BUNDLES=2
STEAM_API_DELAY=2000
FETCH_BUNDLES_DELAY=3000
SKIP_DETAILS_THRESHOLD=50

# CONFIGURA√á√ÉO AGRESSIVA - M√ÅXIMA VELOCIDADE (USE COM CUIDADO)
PARALLEL_BUNDLES=6
STEAM_API_DELAY=800
STEAM_APP_DELAY=200
FETCH_BUNDLES_DELAY=1000
SKIP_DETAILS_THRESHOLD=80
```

### üìä Performance Esperada no Render Free

- **üîç Coleta de bundles b√°sicas:** ~2-3 horas (4840 bundles)
- **üîß Atualiza√ß√£o de detalhes:** ~8-12 horas (processamento completo)
- **üß† Uso de mem√≥ria:** 250-350MB (bem dentro do limite de 500MB)
- **üíæ Opera√ß√µes de disco:** 10-15 salvamentos (vs 2000+ anteriormente)
- **üö´ Rate limiting:** Muito improv√°vel com essas configura√ß√µes
- **üìà Taxa de sucesso:** 95%+ bundles processadas com sucesso

## üöÄ Deploy no Render

### 1. **Configura√ß√£o do reposit√≥rio:**
   - Certifique-se de que o reposit√≥rio est√° no GitHub
   - Fa√ßa commit de todas as altera√ß√µes

### 2. **Configura√ß√£o no Render:**
   - Conecte seu reposit√≥rio GitHub
   - **Escolha:** Web Service
   - **Build Command:** `npm install`
   - **Start Command:** `npm start`
   
### 3. **Vari√°veis de Ambiente (OBRIGAT√ìRIAS):**
   Configure estas vari√°veis exatamente como mostrado:

```properties
NODE_ENV=production
TIMEZONE=America/Sao_Paulo
API_KEY=SUA_CHAVE_SECRETA_AQUI
API_KEY=SUA_CHAVE_SECRETA_AQUI

FETCH_BUNDLES_CONCURRENT=1
FETCH_BUNDLES_DELAY=3000
FETCH_BUNDLES_TIMEOUT=15000

STEAM_API_DELAY=2000
STEAM_APP_DELAY=500
MAX_APPS_PER_BUNDLE=20
REQUEST_TIMEOUT=15000
MAX_RETRIES=3
PARALLEL_BUNDLES=2
APP_BATCH_SIZE=3
SKIP_DETAILS_THRESHOLD=50
```

‚ö†Ô∏è **IMPORTANTE:** 
- **N√ÉO** defina a vari√°vel `PORT` - o Render define automaticamente
- **GERE UMA API_KEY FORTE** para produ√ß√£o: `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`
- **NUNCA compartilhe sua API_KEY** - ela protege seus endpoints administrativos
- **GERE UMA API_KEY FORTE** para produ√ß√£o: `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`
- **NUNCA compartilhe sua API_KEY** - ela protege seus endpoints administrativos

### 4. **Deploy:**
   - O Render detectar√° automaticamente o `package.json`
   - Primeira inicializa√ß√£o demora ~10-15 minutos
   - A API ficar√° dispon√≠vel no dom√≠nio fornecido pelo Render

## üîí Seguran√ßa

### Autentica√ß√£o
- Endpoints administrativos protegidos por API Key
- Rate limiting configurado (100 req/15min para endpoints p√∫blicos, 5 req/15min para admin)
- CORS configurado para produ√ß√£o

### Endpoints Protegidos
Para acessar endpoints administrativos, inclua sua API key:

**Header (recomendado):**
```
X-API-Key: sua_api_key_aqui
```

**Query parameter:**
```
GET /api/force-update?api_key=sua_api_key_aqui
```

## üìã Endpoints Dispon√≠veis

### P√∫blicos
- `GET /` - Status da API
- `GET /health` - Health check detalhado
- `GET /api/bundles` - Lista todas as bundles (b√°sico) com informa√ß√µes de upgrade
- `GET /api/bundles-detailed` - üöÄ **PRINCIPAL:** Endpoint inteligente com atualiza√ß√£o autom√°tica em segundo plano
- `GET /api/bundles-detailed-all` - Todas as bundles detalhadas
- `GET /api/bundles-detailed-legacy` - Comportamento antigo sem intelig√™ncia (para debug)
- `GET /api/bundles-smart` - Alias para `/api/bundles-detailed` (compatibilidade)

### Administrativos (Requer API Key)
- `GET /api/force-update` - For√ßa atualiza√ß√£o completa (8-12 horas no Render)
- `GET /api/update-details` - Atualiza apenas os detalhes das bundles existentes
- `GET /api/test-update?limit=10` - üß™ **RECOMENDADO:** Testa com apenas 10 bundles (1-2 min)
- `GET /api/clean-duplicates` - üßπ Remove duplicatas manualmente

### üîß Monitoramento e Debug
- `GET /api/steam-stats` - üìä **√öTIL:** Estat√≠sticas, configura√ß√µes e status da mem√≥ria
- `GET /health` - Health check detalhado com uso de RAM

### ‚ö†Ô∏è Importante para Render Free
- **Use `/api/test-update?limit=10`** antes de fazer update completo
- **Monitore mem√≥ria** via `/api/steam-stats`
- **Evite m√∫ltiplas atualiza√ß√µes simult√¢neas** - pode causar timeout

### Par√¢metros de Query
- `page`: N√∫mero da p√°gina (padr√£o: 1)
- `limit`: Itens por p√°gina (padr√£o: 10, m√°ximo: 100)

## üõ°Ô∏è Funcionalidades de Seguran√ßa e Estabilidade

### üîí Seguran√ßa
- **Helmet.js**: Headers de seguran√ßa HTTP
- **Rate Limiting**: Prote√ß√£o contra spam/ataques
- **Input Validation**: Valida√ß√£o de par√¢metros de entrada
- **Error Handling**: Tratamento seguro de erros
- **Logging**: Log detalhado de requisi√ß√µes
- **Compression**: Compress√£o gzip para melhor performance
- **CORS**: Pol√≠tica de origem configur√°vel

### üõ†Ô∏è Estabilidade (Render Free)
- **üß† Monitoramento de Mem√≥ria**: Para automaticamente se ultrapassar 350MB
- **üíæ Backup Autom√°tico**: Sistema de rota√ß√£o `bundles.json` ‚Üí `bundles-old.json`
- **ÔøΩ Recupera√ß√£o de Erro**: Restaura backup automaticamente em caso de falha
- **üö® Detec√ß√£o de Bloqueio IP**: Para processamento se Steam bloquear (Status 403)
- **ÔøΩüìä Garbage Collection**: Limpeza autom√°tica de mem√≥ria quando poss√≠vel
- **‚è±Ô∏è Timeouts Inteligentes**: 15s timeout para evitar travamentos

### üìä Monitoramento Avan√ßado

#### Health Check Detalhado (`/health`)
Verifica automaticamente:
- Status do servidor e uptime
- **Uso de mem√≥ria RAM** (cr√≠tico no Render Free)
- Exist√™ncia de arquivos essenciais (`bundles.json`, `bundleDetailed.json`)
- Timestamp da √∫ltima atualiza√ß√£o

#### Steam Stats (`/api/steam-stats`)
Mostra em tempo real:
- **Configura√ß√µes atuais** (delays, paralelismo, etc.)
- **Status da mem√≥ria** (RSS, Heap Used, Heap Total)
- **M√©tricas dos dados** (quantas bundles, √∫ltima atualiza√ß√£o)
- **Indicadores de sa√∫de** (arquivos existem, idade dos dados)

## üîß Desenvolvimento Local

1. **Instalar depend√™ncias:**
   ```bash
   npm install
   ```

2. **Configurar ambiente:**
   ```bash
   cp .env.example .env
   # Edite o arquivo .env com suas configura√ß√µes
   ```

3. **Executar:**
   ```bash
   npm start
   ```

## üéØ Endpoint Principal: `/api/bundles-detailed`

**Agora √© inteligente!** Seu frontend n√£o precisa de mudan√ßas, mas ganha todos os benef√≠cios:

### ‚ú® Funcionalidades Inteligentes (Transparentes)
- **Resposta imediata:** Sempre retorna dados atuais sem delay
- **Atualiza√ß√£o autom√°tica:** Se dados > 8h, atualiza em segundo plano
- **Compatibilidade total:** Mesma estrutura JSON do endpoint antigo
- **Indicador de atualiza√ß√£o:** Campo `updateTriggered` informa se update foi iniciado
- **Fallback inteligente:** Se n√£o tem dados detalhados, retorna b√°sicos

### üìã Estrutura de Resposta (Compat√≠vel)
```json
{
  "totalBundles": 4903,
  "bundles": [...],
  "page": 1,
  "totalPages": 491,
  "hasNext": true,
  "hasPrev": false,
  "lastUpdate": "2025-07-21T11:23:57-03:00",
  "updateTriggered": false  // ‚Üê NOVO: indica se update foi iniciado
}
```

### üîß Uso no Frontend (Sem Mudan√ßas!)
```javascript
// Seu c√≥digo atual continua funcionando exatamente igual
const response = await fetch('/api/bundles-detailed?page=1&limit=20');
const data = await response.json();

// Novo: opcionalmente voc√™ pode mostrar status de atualiza√ß√£o
if (data.updateTriggered) {
  console.log('Dados sendo atualizados em segundo plano...');
}
```

### üßπ Sistema de Limpeza Autom√°tica

- **Detec√ß√£o de duplicatas:** Verifica automaticamente ap√≥s cada atualiza√ß√£o
- **Limpeza autom√°tica:** Remove duplicatas nas bundles b√°sicas e detalhadas
- **Endpoint manual:** `/api/clean-duplicates` para limpeza for√ßada
- **Logs detalhados:** Mostra quantas duplicatas foram removidas

### üìä Monitoramento Avan√ßado

- **Status dos dados:** Idade, quantidade, necessidade de atualiza√ß√£o
- **Detec√ß√£o de descompasso:** Verifica diferen√ßas entre dados b√°sicos e detalhados
- **M√©tricas de duplicatas:** Quantas duplicatas foram detectadas/removidas

### Configura√ß√µes Avan√ßadas (Opcional)

Para ajustar performance vs seguran√ßa, modifique estas vari√°veis:

```bash
# MAIS R√ÅPIDO (risco moderado de bloqueio)
STEAM_API_DELAY=1000          # 1s entre bundles
PARALLEL_BUNDLES=3            # 3 bundles paralelas
SKIP_DETAILS_THRESHOLD=30     # Pula bundles com +30 apps

# MAIS CONSERVADOR (m√°xima seguran√ßa)
STEAM_API_DELAY=5000          # 5s entre bundles  
PARALLEL_BUNDLES=1            # 1 bundle por vez
SKIP_DETAILS_THRESHOLD=20     # Pula bundles com +20 apps
FETCH_BUNDLES_DELAY=5000      # 5s entre lotes de fetch

# DESENVOLVIMENTO LOCAL (conex√£o boa)
STEAM_API_DELAY=300           # 300ms entre bundles
PARALLEL_BUNDLES=10           # 10 bundles paralelas
SKIP_DETAILS_THRESHOLD=100    # Processa bundles maiores
```

### üìä M√©tricas e Logs

**Logs importantes a observar:**
- `üíæ üîÑ Salvamento parcial: X bundles (Y MB)` - Salvamento por mem√≥ria
- `üö® Mem√≥ria alta (X MB) - for√ßando salvamento` - Prote√ß√£o de mem√≥ria ativada
- `üö® BLOQUEIO DETECTADO! IP foi bloqueado` - Steam bloqueou, aguarde 1h
- `üìä Mem√≥ria: X MB | Detalhadas: Y | Lotes: Z` - Status normal

**Indicadores de sa√∫de:**
- Mem√≥ria < 350MB = ‚úÖ OK
- Mem√≥ria > 400MB = ‚ö†Ô∏è Aten√ß√£o  
- Mem√≥ria > 450MB = üö® Cr√≠tico (vai salvar e limpar)

## üß™ Modo Teste (Recomendado)

### Para Render Free - SEMPRE teste primeiro!

```bash
# Teste pequeno (1-2 minutos)
GET /api/test-update?limit=5&api_key=SUA_KEY

# Teste m√©dio (5-10 minutos)  
GET /api/test-update?limit=20&api_key=SUA_KEY

# S√≥ fa√ßa update completo ap√≥s testar!
GET /api/force-update?api_key=SUA_KEY
```

### üîç Verifica√ß√£o de Status

```bash
# Verificar configura√ß√µes e mem√≥ria
GET /api/steam-stats

# Verificar sa√∫de geral
GET /health

# Ver dados atuais
GET /api/bundles-detailed?limit=5
```

## üìà Performance e Limita√ß√µes

### üéØ Performance Esperada (Render Free)
- **Teste (10 bundles):** 1-2 minutos
- **Teste m√©dio (50 bundles):** 5-10 minutos  
- **Update completo (4840 bundles):** 8-12 horas
- **Taxa de sucesso:** 90-95% (algumas bundles s√£o removidas pela Steam)
- **Uso de mem√≥ria:** 250-350MB pico (limite: 500MB)

### ‚ö†Ô∏è Limita√ß√µes do Render Free
- **Timeout:** 15 minutos por requisi√ß√£o web (por isso update roda em background)
- **Sleep:** Servi√ßo dorme ap√≥s 15min sem uso (normal)
- **Cold start:** Primeira requisi√ß√£o ap√≥s sleep demora ~30s
- **Mem√≥ria:** 500MB m√°ximo (nossa configura√ß√£o usa 350MB m√°ximo)

### üö® Troubleshooting

**Se der erro 403 (IP bloqueado):**
```bash
# Aguarde 30-60 minutos e teste novamente
# Ou use configura√ß√µes ainda mais conservadoras:
STEAM_API_DELAY=5000
PARALLEL_BUNDLES=1
```

**Se der timeout no Render:**
```bash
# Use sempre teste primeiro para verificar se est√° funcionando
GET /api/test-update?limit=5&api_key=SUA_KEY
```

**Se der erro de CORS:**
```bash
# Verifique o dom√≠nio da sua aplica√ß√£o frontend
# A API permite automaticamente:
# - *.render.com
# - *.vercel.app  
# - *.netlify.app
# - localhost:*
```

**Se consumir muita mem√≥ria:**
```bash
# Monitore via steam-stats
GET /api/steam-stats

# Reduza o paralelismo se necess√°rio
PARALLEL_BUNDLES=1
```

**Se a API n√£o responder (sleep):**
```bash
# Primeira requisi√ß√£o ap√≥s 15min de inatividade demora ~30s (normal no Render Free)
# Fa√ßa uma requisi√ß√£o simples para "acordar":
GET /health
```

```
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.js          # Autentica√ß√£o e rate limiting
‚îÇ   ‚îú‚îÄ‚îÄ security.js      # Middlewares de seguran√ßa
‚îÇ   ‚îî‚îÄ‚îÄ monitoring.js    # Health check e monitoramento
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ fetchBundles.js  # Busca de bundles
‚îÇ   ‚îî‚îÄ‚îÄ updateBundles.js # Atualiza√ß√£o de detalhes
‚îú‚îÄ‚îÄ routes.js            # Defini√ß√£o de rotas
‚îú‚îÄ‚îÄ server.js            # Servidor principal
‚îî‚îÄ‚îÄ package.json         # Depend√™ncias e scripts
```

## üö® Importante para Produ√ß√£o (Render)

1. **üîë SEMPRE defina uma API_KEY forte** para proteger endpoints administrativos
2. **üß™ TESTE PRIMEIRO** com `/api/test-update?limit=5` antes de fazer update completo
3. **üìä MONITORE MEM√ìRIA** via `/api/steam-stats` regularmente
4. **‚è±Ô∏è SEJA PACIENTE** - update completo demora 8-12h no Render Free (√© normal!)
5. **üö´ EVITE UPDATES M√öLTIPLOS** - um por vez para n√£o estourar mem√≥ria
6. **üîß CONFIGURE CORS** adequadamente para seus dom√≠nios
7. **üìà USE HTTPS** em produ√ß√£o (Render fornece automaticamente)
8. **üîÑ MANTENHA DEPEND√äNCIAS ATUALIZADAS** para patches de seguran√ßa

### üéØ Fluxo Recomendado para Render Free

1. **Deploy inicial** com todas as vari√°veis de ambiente
2. **Teste conectividade:** `GET /health`
3. **Teste pequeno:** `GET /api/test-update?limit=5&api_key=SUA_KEY`
4. **Monitore:** `GET /api/steam-stats`
5. **Se tudo OK, execute completo:** `GET /api/force-update?api_key=SUA_KEY`
6. **Configure agendamento** para atualizar a cada 24-48h
